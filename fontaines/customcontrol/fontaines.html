<div id="legendFontaines">  
  <p class="small" i18n="sidebar.legend.setpoint">
    Cliquez sur une entrée pour filtrer la carte et réitérez le clic pour supprimer le
    filtre
  </p>
  <div id="inputFilterCustom">
    <div class="input__level-one">
      <input
        type="checkbox"
        id="btn-check__dispo24"
        class="btn-check-lgd"
        name="lgd"
        cqltype="fontaines_dispo24"
        value="'OUI'" />
      <label class="btn-legend" for="btn-check__dispo24" style="opacity: 1">
        <img src="apps/fontaines/img/fontaine_dispo24.svg" />
        <span i18n="fontaine.type.disponible24">Disponible 24/24h</span>
      </label>
    </div>
    <div class="input__level-one">
      <input
        type="checkbox"
        id="btn-check__brumisation"
        class="btn-check-lgd"
        name="lgd"
        cqltype="fontaines_brumisante"
        value="'OUI'" />
      <label class="btn-legend" for="btn-check__brumisation" style="opacity: 1">
        <img src="apps/fontaines/img/brumisateur.svg" />
        <span i18n="fontaine.type.brumisation">Avec brumisation</span>
      </label>
    </div>
    <div class="input__level-one">
      <input
        type="checkbox"
        id="btn-check__eau-petillante"
        class="btn-check-lgd"
        name="lgd"
        cqltype="fontaines_petillante"
        value="'OUI'" />
      <label class="btn-legend" for="btn-check__eau-petillante" style="opacity: 1">
        <img src="apps/fontaines/img/eau_petillante.svg" />
        <span i18n="fontaine.type.eaupetillante">Eau pétillante</span>
      </label>
    </div>
    <div id="btn__blockTypesFontaine" class="input__level-one btn__collapse">
      <button onclick="filterDisplayBlock('btn__blockTypesFontaine', 'blockTypesFontaine')">
        <input
          type="checkbox"
          id="btn-check__type-point"
          class="btn-check-lgd"
          name="lgd" />
        <label class="btn-legend" style="opacity: 1">
          <img src="apps/fontaines/img/robinet.svg" />
          <span i18n="sidebar.legend.subtitle.type">Type de fontaine</span>
        </label>
        <span
          ><svg
            xmlns="http://www.w3.org/2000/svg"
            viewBox="0 0 24 24"
            width="20"
            height="20"
            fill="currentColor">
            <path d="M11.9999 13.1714L16.9497 8.22168L18.3639 9.63589L11.9999 15.9999L5.63599 9.63589L7.0502 8.22168L11.9999 13.1714Z"></path></svg>
          </span>
      </button>
    </div>
    <div id="blockTypesFontaine" class="blockDisplay block__collapse">
      <div>
        <input
          type="checkbox"
          id="btn-check__commerce"
          class="btn-check-lgd"
          name="lgd"
          cqltype="commerces" />
        <label class="btn-legend" for="btn-check__commerce" style="opacity: 1">
          <img src="apps/fontaines/img/bouteille.svg" style="width: 48px; padding: 0" />
          <span i18n="fontaine.type.commerce">Ici, je choisis l'eau de Paris</span>
        </label>
      </div>
      <div>
        <input
          type="checkbox"
          id="btn-check9"
          class="btn-check-lgd"
          name="lgd"
          cqltype="fontaines_type"
          value="'BORNE_FONTAINE'" />
        <label class="btn-legend" for="btn-check9" style="opacity: 1">
          <img
            src="apps/fontaines/img/BORNE_FONTAINE.svg"
            style="width: 48px; padding: 0" />
          <span i18n="fontaine.type.borne">Borne fontaine</span>
        </label>
      </div>
      <div>
        <input
          type="checkbox"
          id="btn-check1"
          class="btn-check-lgd"
          name="lgd"
          cqltype="fontaines_type"
          value="'FONTNE_WALLACE'" />
        <label class="btn-legend" for="btn-check1" style="opacity: 1">
          <img
            src="apps/fontaines/img/FONTNE_WALLACE.svg"
            style="width: 48px; padding: 0" />
          <span i18n="fontaine.type.wallace">Fontaine Wallace</span>
        </label>
      </div>
      <div>
        <input
          type="checkbox"
          id="btn-check14"
          class="btn-check-lgd"
          name="lgd"
          cqltype="fontaines_type"
          value="'FONTNE_WALLACE_2EN1'" />
        <label class="btn-legend" for="btn-check14" style="opacity: 1">
          <img
            src="apps/fontaines/img/FONTNE_WALLACE_2EN1.svg"
            style="width: 48px; padding: 0" />
          <span i18n="fontaine.type.wallace.2en1">Fontaine Wallace 2-en-1</span>
        </label>
      </div>
      <div>
        <input
          type="checkbox"
          id="btn-check3"
          class="btn-check-lgd"
          name="lgd"
          cqltype="fontaines_type"
          value="'FONTAINE_TOTEM'" />
        <label class="btn-legend" for="btn-check3" style="opacity: 1">
          <img
            src="apps/fontaines/img/FONTAINE_TOTEM.svg"
            style="width: 48px; padding: 0" />
          <span i18n="fontaine.type.totem">Fontaine Totem</span>
        </label>
      </div>
      <div>
        <input
          type="checkbox"
          id="btn-check15"
          class="btn-check-lgd"
          name="lgd"
          cqltype="fontaines_type"
          value="'FONTAINE_TOTEM_2EN1'" />
        <label class="btn-legend" for="btn-check15" style="opacity: 1">
          <img
            src="apps/fontaines/img/FONTAINE_TOTEM_2EN1.svg"
            style="width: 48px; padding: 0" />
          <span i18n="fontaine.type.2en1">Fontaine Totem 2-en-1</span>
        </label>
      </div>
      <div>
        <input
          type="checkbox"
          id="btn-check4"
          class="btn-check-lgd"
          name="lgd"
          cqltype="fontaines_type"
          value="'FTNE_PETILLANTE'" />
        <label class="btn-legend" for="btn-check4" style="opacity: 1">
          <img
            src="apps/fontaines/img/FTNE_PETILLANTE.svg"
            style="width: 48px; padding: 0" />
          <span i18n="fontaine.type.petillante">Fontaine pétillante</span>
        </label>
      </div>
      <div>
        <input
          type="checkbox"
          id="btn-check5"
          class="btn-check-lgd"
          name="lgd"
          cqltype="fontaines_type"
          value="'FTNE_MILLENAIRE'" />
        <label class="btn-legend" for="btn-check5" style="opacity: 1">
          <img
            src="apps/fontaines/img/FTNE_MILLENAIRE.svg"
            style="width: 48px; padding: 0" />
          <span i18n="fontaine.type.millenaire">Fontaine du Millénaire</span>
        </label>
      </div>
      <div>
        <input
          type="checkbox"
          id="btn-check6"
          class="btn-check-lgd"
          name="lgd"
          cqltype="fontaines_type"
          value="'FONTAINE_ARCEAU'" />
        <label class="btn-legend" for="btn-check6" style="opacity: 1">
          <img
            src="apps/fontaines/img/FONTAINE_ARCEAU.svg"
            style="width: 48px; padding: 0" />
          <span i18n="fontaine.type.arceau">Fontaine Arceau</span>
        </label>
      </div>
      <div>
        <input
          type="checkbox"
          id="btn-check7"
          class="btn-check-lgd"
          name="lgd"
          cqltype="fontaines_type"
          value="'FTNE_POING_EAU'" />
        <label class="btn-legend" for="btn-check7" style="opacity: 1">
          <img
            src="apps/fontaines/img/FTNE_POING_EAU.svg"
            style="width: 48px; padding: 0" />
          <span i18n="fontaine.type.poing">Fontaine Poing d'eau</span>
        </label>
      </div>
      <div>
        <input
          type="checkbox"
          id="btn-check8"
          class="btn-check-lgd"
          name="lgd"
          cqltype="fontaines_type"
          value="'FONTAINE_ALBIEN'" />
        <label class="btn-legend" for="btn-check8" style="opacity: 1">
          <img
            src="apps/fontaines/img/FONTAINE_ALBIEN.svg"
            style="width: 48px; padding: 0" />
          <span i18n="fontaine.type.albien">Fontaine à l'Albien</span>
        </label>
      </div>
      <div>
        <input
          type="checkbox"
          id="btn-check2"
          class="btn-check-lgd"
          name="lgd"
          cqltype="fontaines_type"
          value="'FONTAINE_BOIS'" />
        <label class="btn-legend" for="btn-check2" style="opacity: 1">
          <img
            src="apps/fontaines/img/BORNE_FONTAINE.svg"
            style="width: 48px; padding: 0" />
          <span i18n="fontaine.type.bois">Fontaine des bois, parcs et jardins</span>
        </label>
      </div>
      <div>
        <input
          type="checkbox"
          id="btn-check16"
          class="btn-check-lgd"
          name="lgd"
          cqltype="fontaines_type"
          value="'FTNE_MAT_SOURCE_2EN1'" />
        <label class="btn-legend" for="btn-check16" style="opacity: 1">
          <img
            src="apps/fontaines/img/FTNE_MAT_SOURCE_2EN1.svg"
            style="width: 48px; padding: 0" />
          <span i18n="fontaine.type.mat">Fontaine Mât Source 2-en-1</span>
        </label>
      </div>      
    </div>
    <div id="btn__blockLegende" class="input__level-one btn__collapse">
      <button onclick="filterDisplayBlock('btn__blockLegende', 'blockLegend')">
        <input
          type="checkbox"
          id="btn-check__legende"
          class="btn-check-lgd"
          name="lgd" />
        <label class="btn-legend" style="opacity: 1">
          <span i18n="sidebar.legend.subtitle.legende">Légende</span>
        </label>
        <span
          ><svg
            xmlns="http://www.w3.org/2000/svg"
            viewBox="0 0 24 24"
            width="20"
            height="20"
            fill="currentColor">
            <path d="M11.9999 13.1714L16.9497 8.22168L18.3639 9.63589L11.9999 15.9999L5.63599 9.63589L7.0502 8.22168L11.9999 13.1714Z"></path></svg>
          </span>
      </button>
    </div>
    <div id="blockLegend" class="blockDisplay block__collapse">
      <div>
        <input
          type="checkbox"
          id="btn-check__co"
          class="btn-check-lgd"
          name="lgd"
          cqltype="commerces"/>
        <label class="btn-legend" for="btn-check__co" style="opacity: 1">
          <img
            src="apps/fontaines/img/commerce.svg"
            style="width: 48px; padding: 5px" />
          <span i18n="legende.commerce">Commerces</span>
        </label>
      </div>
      <div>
        <input
          type="checkbox"
          id="btn-check11"
          class="btn-check-lgd"
          name="lgd"
          cqltype="fontaines_d"
          value="'OUI'" />
        <label class="btn-legend" for="btn-check11" style="opacity: 1">
          <img
            src="apps/fontaines/img/fontaine_disponible2.svg"
            style="width: 48px; padding: 5px" />
          <span i18n="fontaine.disponible">Fontaine en service</span>
        </label>
      </div>
      <div>
        <input
          type="checkbox"
          id="btn-check12"
          class="btn-check-lgd"
          name="lgd"
          cqltype="fontaines_d"
          value="'NON'" />
        <label class="btn-legend" for="btn-check12" style="opacity: 1">
          <img
            src="apps/fontaines/img/fontaine_indisponible.svg"
            style="width: 48px; padding: 5px" />
          <span i18n="fontaine.indisponible">Fontaine indisponible</span>
        </label>
      </div>
    </div>
  </div>
  <div id="section_date_maj"></div>
</div>
<script>
// Init variables
let list_types = [];
let list_dispo = [];
let list_dispo24 = [];
let list_petillante = [];
let list_brumisante = [];

// Manage type of fontains block
function filterDisplayBlock(targetBtn, targetBlock) {
  const block = document.getElementById(targetBlock);
  block.classList.toggle("blockDisplay");
  const btn = document.getElementById(targetBtn);
  btn.classList.toggle("icon-blockDisplay");
}
// Function to reset filter
function resetFilter() {
  // Empty CQL lists and delete CQL Filter
  list_types = [];
  list_dispo = [];
  list_dispo24 = [];
  list_petillante = [];
  list_brumisante = [];
  fontaines_filters = [];
  deleteCQLFilter();
  // Opacity 1 for all labels
  let labels = document.querySelectorAll(".btn-check-lgd ~ label");
  labels.forEach(function (label) {
    label.style.opacity = "1";
  });
  // Delete checkOnMap class input
  let checkOnMap = document.querySelectorAll(".btn-check-lgd.checkOnMap");
  checkOnMap.forEach(function (checkbox) {
    checkbox.classList.remove("checkOnMap");
  });
  // Display all layers
  mviewer.getLayer("commerce").layer.setVisible(true);
  mviewer.getLayer("fontaines").layer.setVisible(true);
}

// Function to add input value in cql list
function valueInList(nameList, value) {
  if (nameList.includes(value)) {
    const index = nameList.indexOf(value);
    const x = nameList.splice(index, 1);
  } else {
    nameList.push(value);
  }
}

// Function to filter map by CQL filter
function filterDataByAttr(valAtt) {
  var layer = mviewer.getLayer("fontaines");
  var src = layer.layer.getSource();
  var params = src.getParams();
  // update wms layer params
  params.CQL_FILTER = `${valAtt}`;
  src.updateParams(params);
  src.refresh();
}

// Function to delete CQLFILTER from WMS layers
function deleteCQLFilter() {
  var layer = mviewer.getLayer("fontaines");
  var src = layer.layer.getSource();
  var params = src.getParams();
  delete params.CQL_FILTER;
  src.refresh();
}

//Functions to delete checkOnMap class
function checkOnMap(input) {
  let checkOnMap = document.querySelectorAll(
    "#inputFilterCustom .btn-check-lgd.checkOnMap",
  );
  if (checkOnMap.length > 0 && checkOnMap == input) {
    checkOnMap.forEach(function (checkbox) {
      checkbox.classList.remove("checkOnMap");
    });
  }
}

// Get two level inputs in Type fontaines
let checkboxes = document.querySelectorAll(
  "#inputFilterCustom input[type=checkbox][name=lgd]",
);
checkboxes.forEach(function (checkbox) {
  checkbox.addEventListener("change", function (e) {
    console.log(e);
    let input = e.target;
    checkOnMap(input);
    // Add class to input checked
    input.classList.toggle("checkOnMap");
    // Get input value and cql type
    let cqlvalue = input.value;
    let cqltype = input.getAttribute("cqltype");
    // Manage layer fontaines
    // Add the value to the corresponding list
    switch(cqltype) {
      case "fontaines_dispo24":
        valueInList(list_dispo24, cqlvalue);
        break;
      case "fontaines_d":
        valueInList(list_dispo, cqlvalue);
        break;
      case "fontaines_type":
        valueInList(list_types, cqlvalue);
        break;
      case "fontaines_petillante":
        valueInList(list_petillante, cqlvalue);
        break;
      case "fontaines_brumisante":
        valueInList(list_brumisante, cqlvalue);
        break;
      default:
        null;
    }

    // Create expression for cql filter
    let cql_filter_types;
    let cql_filter_dispo;
    let cql_filter_dispo24;
    let cql_filter_petillante;
    let cql_filter_brumisante;
    let fontaines_filters = [];
    if (list_types.length > 0) {
      cql_filter_types = `type_objet IN (${list_types})`;
      fontaines_filters.push(cql_filter_types);
    }
    if (list_dispo.length > 0) {
      cql_filter_dispo = `dispo IN (${list_dispo})`;
      fontaines_filters.push(cql_filter_dispo);
    }
    if (list_dispo24.length > 0) {
      cql_filter_dispo24 = `dispo_24 IN (${list_dispo24})`;
      fontaines_filters.push(cql_filter_dispo24);
    }
    if (list_petillante.length > 0) {
      cql_filter_petillante = `petillante IN (${list_petillante})`;
      fontaines_filters.push(cql_filter_petillante);
    }
    if (list_brumisante.length > 0) {
      fontaines_filters.push(`brumisante IN (${list_brumisante})`);
    }

    // Get status of commerces => Actif or not
    let commercesChecked = document.querySelectorAll(
      "input[cqltype=commerces][name=lgd].checkOnMap",
    );

    let commercesNotSelected = _.isEmpty(commercesChecked);
    let commerceSelected = !commercesNotSelected;
    
    let fontainesNotSelected = _.isEmpty(fontaines_filters);
    let fontainesSelected = !fontainesNotSelected;

    let isNotBrumisante = _.isEmpty(list_brumisante);
    let isBrumisante = !isNotBrumisante;
    
    let isNotPetillante = _.isEmpty(list_petillante);
    let isPetillante = !isNotPetillante;

    let isNot24h24 = _.isEmpty(list_dispo24);
    let is24h24 = !isNot24h24;
    
    let isNotDispo = _.isEmpty(list_dispo);
    let isDispo = !isNotDispo;

    // Manage display layers for each case
    // si commerces selectionnés et les fontaines selectionnés
    if (fontainesSelected && commerceSelected) {
      
      // si 24/24 + je choisis eau de paris => masquer les commerces et les fontaines
      // si 24/24 + je choisis eau de paris + fontaines => masquer les commerces et les fontaines      
      filterDataByAttr(fontaines_filters.join(" AND "));

      // Pour la combinaison Commerces + Dispo24 > Commerces et fontaines ne sont pas affichés.
      // On affiche donc les commerces et fontaines que si ce n'est pas du dispo 24/24.
      mviewer.getLayer("fontaines").layer.setVisible(isNot24h24);
      mviewer.getLayer("commerce").layer.setVisible(isNot24h24);

      // Combinaison Dispo + Dispo24 > Fontaines non affichées
      // si 24/24 + fontaines en service => fontaines non affichés
      // si 24/24 + fontaines indispo => fontaines non affichés
      if (isDispo && is24h24) {
        mviewer.getLayer("fontaines").layer.setVisible(false);
      }

      // si eau brumisante => Masquer les commerces
      // si eau pétillante => Masquer les commerces
      // si 24/24 + fontaines en service => commerces non affichés
      // si 24/24 + fontaines indispo => commerces non affichés
      if(isPetillante || isBrumisante || (isDispo && is24h24)) {
        mviewer.getLayer("commerce").layer.setVisible(false);
      }


    } else if (fontainesSelected && commercesNotSelected) {
      // pas de commerce mais fontaines sélectionnées
      // si 24/24 + fontaines en service => fontaines et commerces non affichés
      // si 24/24 + fontaines indispo => fontaines et commerces non affichés
      
      filterDataByAttr(fontaines_filters.join(" AND "));
      mviewer.getLayer("commerce").layer.setVisible(false);

      // Combinaison Dispo + Dispo24 > Fontaines non affichées
      const hideFontaine = isDispo && is24h24;
      const showFontaine = !hideFontaine;
      mviewer.getLayer("fontaines").layer.setVisible(showFontaine);

    } else if (fontainesNotSelected && commerceSelected) {
      // on a que des commerces
      // On masque les fontaines
      deleteCQLFilter();
      mviewer.getLayer("fontaines").layer.setVisible(false);
      mviewer.getLayer("commerce").layer.setVisible(true);
    } else {
      resetFilter();
    }
  });
});

</script>
<style>
  #blockTypesFontaine label span, #blockLegend label span {
      font-style: italic;
      font-size: 0.93em;
  }

  #blockTypesFontaine label img, #blockLegend label img {
      width:45px!important;
  }

  #btn__blockLegende button {
      padding: 15px 0;
  } 

  #inputFilterCustom input.checkOnMap ~ label {
    opacity: 1 !important;
  }

  #inputFilterCustom:has(.checkOnMap) .btn-check-lgd:not(.checkOnMap) ~ label {
    opacity: 0.4 !important;
  }

  .btn__collapse.icon-blockDisplay svg {
    transform: rotate(180deg);
  }

  .btn__collapse svg {
    transition: all 0.2s ease-in-out;
  }

  a.icon-options {
    display: none !important;
  }

  .input__level-one:not(:first-child) {
    margin-top: -20px;
  }

  .input__level-one:first-child {
    margin-top: -10px;
  }

  .input__level-one img {
    width: 33px;
    padding: 0;
    margin-right: 12px;
  }

  .blockDisplay {
    display: none;
  }

  .btn__collapse button {
    background: none;
    border: none;
    display: flex;
    width: 100%;
    align-items: center;
    font-weight: 500;
    font-size: 1.2rem;
    color: #5e5e5e;
    justify-content: space-between;
    flex-direction: row;
    padding: 0;
  }

  .block__collapse > div {
    margin-top: -15px;
  }

  .block__collapse {
    padding: 0.2em 1em 0em 1em;
  }

  #section_date_maj {
    color: #a7a7a7;
    margin: 2em 0 !important;
  }
  
  #legend .layerdisplay-title,
  #legend .layerdisplay-legend {
    display: none;
  }

  #btnLegend {
    padding: 10px 0px;
  }

  #legend-fontaines {
    display: none;
  }

  .btn-legend:active {
    box-shadow: none;
  }

  .btn-legend:hover {
    opacity: 0.7 !important;
    cursor: pointer;
  }

  #legendFontaines label {
    display: flex;
    align-items: center;
    font-weight: 500;
    font-size: 1.2rem;
    color: #5e5e5e;
  }

  #legendFontaines input {
    display: none;
  }

  #legendFontaines label span {
    line-height: 1;
  }

  #legendFontaines h5 {
    text-transform: uppercase;
    font-size: 11px;
    letter-spacing: 1px;
    opacity: 0.6;
    margin-bottom: 20px;
  }
</style>
